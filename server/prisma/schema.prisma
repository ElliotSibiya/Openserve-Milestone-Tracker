generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  password  String
  role      String   @default("staff") // staff, admin, superadmin
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  createdProjects  Project[]      @relation("CreatedProjects")
  completedPhases  ProjectPhase[] @relation("CompletedPhases")
  notifications    Notification[]
  settingsUpdates  GlobalSettings[] @relation("SettingsUpdatedBy")
}

model GlobalSettings {
  id                     String   @id @default(cuid())
  defaultPlanningDays    Int      @default(10)
  defaultFundingDays     Int      @default(2)
  defaultWayleaveDays    Int      @default(0)
  defaultMaterialsDays   Int      @default(15)
  defaultAnnouncementDays Int     @default(1)
  defaultKickOffDays     Int      @default(2)
  defaultBuildDays       Int      @default(20)
  defaultEccDays         Int      @default(1)
  defaultIntegrationDays Int      @default(2)
  defaultRfaDays         Int      @default(1)
  updatedBy              String?
  updatedAt              DateTime @updatedAt

  // Relations
  updatedByUser User? @relation("SettingsUpdatedBy", fields: [updatedBy], references: [id])
}

model Project {
  id                   String   @id @default(cuid())
  orderNumber          String
  customerName         String
  pnr                  String
  timelineProvidedBy   String
  timelineDateProvided DateTime
  siteSurveyDate       DateTime
  createdBy            String
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  createdByUser User           @relation("CreatedProjects", fields: [createdBy], references: [id])
  phases        ProjectPhase[]
  notifications Notification[]
}

model ProjectPhase {
  id          String    @id @default(cuid())
  projectId   String
  phaseName   String    // planning, funding, wayleave, materials, announcement, kickoff, build, fqa, ecc, integration, rfa, com
  allowedDays Int
  deadline    DateTime
  isComplete  Boolean   @default(false)
  completedBy String?
  completedAt DateTime?

  // Relations
  project          Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  completedByUser  User?   @relation("CompletedPhases", fields: [completedBy], references: [id])

  @@unique([projectId, phaseName])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  projectId String
  phaseName String
  type      String   // warning, urgent, overdue
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId, phaseName])
}
